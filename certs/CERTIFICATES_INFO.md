# Apple Pay Certificates Directory

This directory contains the certificates required for Apple Pay integration with GMO Payment Gateway.

## üîê Required Certificates (DO NOT DELETE)

### 1. Merchant Identity Certificate (for Apple Merchant Validation)

**Purpose**: Authenticate with Apple's servers during merchant validation
**Used by**: Backend Django app during Apple Pay checkout

| File | Purpose | Status |
|------|---------|--------|
| `merchant-identity-cert.pem` | Public certificate | ‚úÖ Valid until Nov 6, 2027 |
| `merchant-identity-key.pem` | Private key | ‚úÖ Matches certificate |
| `applepay-merchant-identity.p12` | Source P12 bundle | ‚úÖ Backup/Source file |

**Certificate Details**:
- Merchant ID: `merchant.alpha.throwinglow`
- Issuer: Apple Worldwide Developer Relations CA (G3)
- Valid: Oct 7, 2025 - Nov 6, 2027
- Subject: `merchant.alpha.throwinglow`

**Environment Variables** (configured in `.env`):
```bash
APPLE_MERCHANT_IDENTITY_CERT_PATH=/certs/merchant-identity-cert.pem
APPLE_MERCHANT_IDENTITY_KEY_PATH=/certs/merchant-identity-key.pem
```

### 2. Payment Processing Certificate (for GMO Payment Gateway)

**Purpose**: Decrypt Apple Pay payment tokens
**Used by**: GMO Payment Gateway (uploaded to their dashboard)

| File | Purpose | Status |
|------|---------|--------|
| `applepay-payment-processing-gmo.p12` | For GMO PG upload | ‚úÖ Valid until Nov 4, 2027 |
| `payment-processing.pem` | PEM version (backup) | ‚úÖ Valid |
| `payment-processing.key` | Private key (backup) | ‚úÖ Valid |

**Certificate Details**:
- Merchant ID: `merchant.alpha.throwinglow`
- Issuer: Apple Worldwide Developer Relations CA
- Valid: Oct 5, 2025 - Nov 4, 2027
- Purpose: Apple Pay Payment Processing

**‚ö†Ô∏è ACTION REQUIRED**:
Upload `applepay-payment-processing-gmo.p12` to GMO PG merchant dashboard:
1. Log in to GMO PG dashboard
2. Navigate to Payment Settings ‚Üí Apple Pay
3. Upload `applepay-payment-processing-gmo.p12`
4. Enter the P12 password (if set during creation)

### 3. SSL Certificates (for HTTPS)

| File | Purpose | Status |
|------|---------|--------|
| `server.crt` | Self-signed SSL cert | Auto-generated by Docker |
| `server.key` | Self-signed SSL key | Auto-generated by Docker |
| `localhost.crt` | Alternative SSL cert | Legacy |
| `localhost.key` | Alternative SSL key | Legacy |

**Note**: These are auto-generated on container start if missing. For production, use a CA-signed certificate (Let's Encrypt).

## üóëÔ∏è Legacy/Duplicate Files (Can be removed)

These files are duplicates or legacy formats that are no longer needed:

- `apple_pay.cer` - Duplicate of payment processing cert
- `merchant_id.cer` - Duplicate in DER format
- `merchantcert.crt` - Duplicate
- `merchantcert (1).crt` - Duplicate
- `merchant-identity.csr` - Certificate Signing Request (already used)
- `payment-processing.csr` - Certificate Signing Request (already used)
- `merchant-identity.pem` - Duplicate/old version
- `merchant-identity.key` - Old format (superseded by merchant-identity-key.pem)

## üîí Security Best Practices

### File Permissions

Private keys should have restricted permissions:
```bash
chmod 600 merchant-identity-key.pem
chmod 600 payment-processing.key
chmod 600 *.key
chmod 644 merchant-identity-cert.pem  # Public cert can be readable
```

### Git Ignore

All certificate files are excluded from version control via `.gitignore`:
```
certs/*.pem
certs/*.p12
certs/*.key
certs/*.crt
certs/*.cer
```

**NEVER commit private keys to git!**

### Backup

Keep secure backups of:
- ‚úÖ `applepay-merchant-identity.p12` (with password)
- ‚úÖ `applepay-payment-processing-gmo.p12` (with password)

Store in secure location (password manager, encrypted drive, secure cloud storage).

## üìÖ Certificate Renewal Schedule

### Merchant Identity Certificate
- **Current Expiry**: Nov 6, 2027
- **Renewal Due**: Oct 2027 (1 month before expiry)
- **Process**: Create new CSR ‚Üí Upload to Apple Developer ‚Üí Download new cert

### Payment Processing Certificate
- **Current Expiry**: Nov 4, 2027
- **Renewal Due**: Sep 2027 (2 months before expiry)
- **Process**: Create new CSR ‚Üí Upload to Apple Developer ‚Üí Upload to GMO PG

### Set Calendar Reminders:
- [ ] Oct 1, 2027 - Renew Merchant Identity Certificate
- [ ] Sep 1, 2027 - Renew Payment Processing Certificate

## üîç Certificate Verification Commands

### Check Certificate Expiry
```bash
openssl x509 -in merchant-identity-cert.pem -noout -dates
openssl x509 -in payment-processing.pem -noout -dates
```

### Verify Certificate and Key Match
```bash
openssl x509 -noout -modulus -in merchant-identity-cert.pem | openssl md5
openssl rsa -noout -modulus -in merchant-identity-key.pem | openssl md5
# If MD5 hashes match, cert and key are a pair ‚úÖ
```

### Verify Private Key
```bash
openssl rsa -in merchant-identity-key.pem -check
# Should output: RSA key ok
```

### View Certificate Details
```bash
openssl x509 -in merchant-identity-cert.pem -noout -text
```

### Extract Certificate from P12 (if needed)
```bash
# Extract certificate
openssl pkcs12 -in applepay-merchant-identity.p12 -clcerts -nokeys -out merchant-identity-cert.pem

# Extract private key
openssl pkcs12 -in applepay-merchant-identity.p12 -nocerts -out merchant-identity-key.pem -nodes
```

## üöÄ Quick Setup Check

Run this from project root to verify certificates are properly configured:

```bash
docker-compose up -d backend
curl -k https://localhost:8443/api/payments/config/status/ | jq
```

Expected output:
```json
{
  "all_valid": true,
  "apple_pay": {
    "valid": true,
    "errors": [],
    "warnings": [],
    "configured": {
      "cert_file_exists": true,
      "key_file_exists": true
    }
  }
}
```

## üìû Troubleshooting

### Error: "Certificate not found"
- Check file paths in `.env` match actual filenames
- Verify Docker volume mount: `./certs:/certs`
- Check file permissions (should be readable by Docker user)

### Error: "Certificate expired"
- Run: `openssl x509 -in merchant-identity-cert.pem -noout -dates`
- If expired, renew certificate in Apple Developer portal

### Error: "Certificate and key don't match"
- Verify MD5 hashes match (see commands above)
- Re-extract from P12 if needed

### Error: "GMO PG can't decrypt payment token"
- Ensure `applepay-payment-processing-gmo.p12` is uploaded to GMO dashboard
- Verify correct Merchant ID in GMO settings
- Check certificate hasn't expired

## üìö Additional Resources

- [Apple Pay Documentation](https://developer.apple.com/apple-pay/)
- [GMO PG Apple Pay Setup](https://www.gmo-pg.com/en/service/mulpay/apple-pay/)
- [Project Setup Guide](../SETUP_GUIDE.md)
- [Fixes Applied](../FIXES_APPLIED.md)

---

**Last Updated**: 2025-11-09
**Certificate Status**: ‚úÖ All valid, expires 2027
**Action Required**: Upload `applepay-payment-processing-gmo.p12` to GMO PG
