services:
  # Certificate generation service (runs once to create certs)
  cert-generator:
    image: alpine:latest
    container_name: cert_generator
    volumes:
      - ./certs:/certs
      - ./scripts:/scripts
    command: sh /scripts/generate-certs-docker.sh
    profiles:
      - setup

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: applepay_backend
    ports:
      - "8000:8000"
      - "8443:8443"  # HTTPS port
    env_file:
      - .env
    environment:
      - SECRET_KEY=${SECRET_KEY:-django-insecure-change-this-in-production}
      - DEBUG=${DEBUG:-True}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1,backend}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://localhost:3443,https://localhost:3000,http://localhost:3000}
      - GMO_SHOP_ID=${GMO_SHOP_ID:-}
      - GMO_SHOP_PASS=${GMO_SHOP_PASS:-}
      - GMO_API_ENDPOINT=${GMO_API_ENDPOINT:-https://pt01.mul-pay.jp}
      - APPLE_MERCHANT_ID=${APPLE_MERCHANT_ID:-}
      - APPLE_MERCHANT_IDENTITY_CERT_PATH=${APPLE_MERCHANT_IDENTITY_CERT_PATH:-/certs/merchant-identity-cert.pem}
      - APPLE_MERCHANT_IDENTITY_KEY_PATH=${APPLE_MERCHANT_IDENTITY_KEY_PATH:-/certs/merchant-identity-key.pem}
    volumes:
      - ./backend:/app
      - ./certs:/certs
      - backend_static:/app/staticfiles
      - backend_media:/app/media
      - backend_logs:/app/logs
    command: >
      sh -c "
      if [ ! -f /certs/server.crt ]; then
        echo 'Generating SSL certificates...' &&
        mkdir -p /certs &&
        openssl genrsa -out /certs/server.key 2048 &&
        openssl req -new -x509 -key /certs/server.key -out /certs/server.crt -days 365 -subj '/C=US/ST=Dev/L=Local/O=ApplePayPOC/CN=localhost' -addext 'subjectAltName=DNS:localhost,DNS:*.localhost,IP:127.0.0.1' &&
        chmod 600 /certs/server.key &&
        chmod 644 /certs/server.crt &&
        echo 'SSL certificates generated';
      fi &&
      python manage.py makemigrations &&
      python manage.py migrate &&
      python manage.py runserver_plus --cert-file /certs/server.crt --key-file /certs/server.key 0.0.0.0:8443
      "
    restart: unless-stopped
    networks:
      - applepay_network
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"https://localhost:8443/admin/\", context=__import__(\"ssl\")._create_unverified_context())' || python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8000/admin/\")' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: applepay_frontend
    ports:
      - "3000:3000"
      - "3443:3443"  # HTTPS port
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://localhost:8443}
      - SSL_CERT_PATH=/certs/server.crt
      - SSL_KEY_PATH=/certs/server.key
      - NEXT_TURBO=0
    volumes:
      - ./frontend:/app
      - ./certs:/certs
      - /app/node_modules
      - /app/.next
    command: >
      sh -c "
      if [ ! -f /certs/server.crt ]; then
        echo 'Generating SSL certificates...' &&
        mkdir -p /certs &&
        openssl genrsa -out /certs/server.key 2048 &&
        openssl req -new -x509 -key /certs/server.key -out /certs/server.crt -days 365 -subj '/C=US/ST=Dev/L=Local/O=ApplePayPOC/CN=localhost' -addext 'subjectAltName=DNS:localhost,DNS:*.localhost,IP:127.0.0.1' &&
        chmod 600 /certs/server.key &&
        chmod 644 /certs/server.crt &&
        echo 'SSL certificates generated';
      fi &&
      NODE_OPTIONS="--no-warnings" NEXT_TURBO=0 node server.js
      "
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - applepay_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-check-certificate --no-verbose --tries=1 --spider https://localhost:3443/ || wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 40s

volumes:
  backend_static:
  backend_media:
  backend_logs:

networks:
  applepay_network:
    driver: bridge

